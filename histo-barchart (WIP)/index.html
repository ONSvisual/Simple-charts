<!DOCTYPE html>
<html lang="en">

<head>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <title>Histo-barchart</title>

  <meta name="description" content="">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <link rel="stylesheet" href="../lib/globalStyle.css" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">

  <style type="text/css">
    h6 {
      font-size: 16px;
      margin: 16px 0 8px 0;
      font-weight: 700;
      color: #323132;
    }
  </style>

</head>


<body>

  <div id="graphic">
    <img src="fallback.png" alt="[Chart]" />
  </div>

  <h6 id="source"></h6>

  <div id="keypoints">
    <p></p>
  </div>

  <!--<div class="footer">
   </div>-->

  <div id="footer">
  </div>

  <script src="https://cdn.ons.gov.uk/vendor/d3/4.13.0/d3.min.js" type="text/javascript"></script>
  <script src="../lib/modernizr.svg.min.js" type="text/javascript"></script>
  <script src="../lib/pym.js" type="text/javascript"></script>
  <script>
    var graphic = d3.select('#graphic');
    var keypoints = d3.select('#keypoints');
    var footer = d3.select(".footer");
    var pymChild = null;

    function drawGraphic(width) {
      var threshold_md = 414;
      var threshold_sm = dvc.optional.mobileBreakpoint;

      //set variables for chart dimensions dependent on width of #graphic
      if (parseInt(graphic.style("width")) < threshold_sm) {
        var margin = {
          top: dvc.optional.margin_sm[0],
          right: dvc.optional.margin_sm[1],
          bottom: dvc.optional.margin_sm[2],
          left: dvc.optional.margin_sm[3]
        };
        var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
        var height = Math.ceil((chart_width * dvc.optional.aspectRatio_sm[1]) / dvc.optional.aspectRatio_sm[0]) - margin.top - margin.bottom;
      } else if (parseInt(graphic.style("width")) < threshold_md) {
        var margin = {
          top: dvc.optional.margin_md[0],
          right: dvc.optional.margin_md[1],
          bottom: dvc.optional.margin_md[2],
          left: dvc.optional.margin_md[3]
        };
        var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
        var height = Math.ceil((chart_width * dvc.optional.aspectRatio_md[1]) / dvc.optional.aspectRatio_md[0]) - margin.top - margin.bottom;
      } else {
        var margin = {
          top: dvc.optional.margin_lg[0],
          right: dvc.optional.margin_lg[1],
          bottom: dvc.optional.margin_lg[2],
          left: dvc.optional.margin_lg[3]
        };
        var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
        var height = Math.ceil((chart_width * dvc.optional.aspectRatio_lg[1]) / dvc.optional.aspectRatio_lg[0]) - margin.top - margin.bottom;
      }


      // clear out existing graphics
      graphic.selectAll("*").remove();
      keypoints.selectAll("*").remove();
      footer.selectAll("*").remove();

      var x = d3.scaleLinear()
        .range([0, chart_width]);

      var y = d3.scaleLinear()
        .range([height, 0]);

      var xAxis = d3.axisBottom(x)
        .tickSize(0)
        .tickFormat("")

      var yAxis = d3.axisLeft(y);

      //gridlines
      var y_axis_grid = function() {
        return yAxis;
      }

      //remap the data
      boxes=[]
      var xacc=0
      for(i=0;i<graphic_data.length;i++){

        boxes.push({
          "name":graphic_data[i].name,
          "yAxisValue":+graphic_data[i].yAxisValue,
          "xAxisValue":+graphic_data[i].Proportion/+graphic_data[i].yAxisValue,
          "xacc":xacc
        })
        xacc=xacc+(+graphic_data[i].Proportion/+graphic_data[i].yAxisValue)
      }
      lastx=xacc

      x.domain([0,lastx])

      y.domain(dvc.essential.yAxisScale);

      //create svg for chart
      var legend = d3.select('#graphic').append('svg')
        //.attr("width", chart_width + margin.left + margin.right)
        //.attr("height", margin.bottom +330) //height + margin.top + margin.bottom +30)
        .append("g")
        .attr("id", "legend");


      //var svg = d3.select('#graphic').append('svg')
      var svg = d3.select('svg')
        .attr("id", "chart")
        .style("background-color", "#fff")
        .attr("width", chart_width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom) //+30)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


      svg.append("rect")
        .style("fill", "#fff")
        .attr("width", chart_width)
        .attr("height", height);

      svg.append('g')
        .attr('class', 'y axis')
        .call(yAxis);

      svg.append('g')
        .attr('class', 'y grid')
        .call(y_axis_grid()
          .tickSize(-chart_width, 0, 0)
          .tickFormat('')
        );

      //y axis label
      svg.append("text")
        //.attr('class', 'unit')
        .attr('transform', 'translate(' + -margin.left + ',-10)') // " + eval(-margin.top + (lineNo+1)*20) + "
        .attr("font-size", "12px")
        .attr("fill", "#666")
        .text(function(d, i) {
          return dvc.essential.yAxisLabel
        });


      //create x axis, if y axis doesn't start at 0 drop x axis accordingly
      svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', function(d) {
            return 'translate(0,' + height + ')'
        })
        .call(xAxis);

      svg.append('g')
        .attr("class","boxes")
        .selectAll('rect')
        .data(boxes)
        .enter()
        .append('rect')
        .attr('y',function(d){return y(d.yAxisValue)})
        .attr('x',function(d){return x(d.xacc)})
        .attr('height',function(d){return y(0)-y(d.yAxisValue)})
        .attr('width',function(d){return x(d.xAxisValue)})
        .style("fill",function(d,i){return dvc.essential.colour_palette[i]});


      //create link to source
      d3.select('#source')
        .text('Source: ' + dvc.essential.sourceText);



      createLegend();

      function createLegend() {

        var prevX = 0;
        var prevY = 0;
        lineNo = 0;
        var lineNoOld = 0;

        dvc.essential.legendLabels.forEach(function(d, i) {

          // draw legend text based on content of var legendLabels ...
          var_group = d3.select("#legend").append("g")

          var_group.append("rect")
            .attr("class", "rect" + i)
            .attr("fill", dvc.essential.colour_palette[i])
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", function(d) {
              if (dvc.essential.legendStyle == "rect") {
                return 15;
              } else {
                return 20;
              }
            })
            .attr("height", function(d) {
              if (dvc.essential.legendStyle == "rect") {
                return 15;
              } else {
                return 3;
              }
            })

          var_group.append("text")
            .text(dvc.essential.legendLabels[i])
            .attr("class", "legend" + i)
            .attr("text-anchor", "start")
            .style("font-size", "12px")
            .style("fill", "#666")
            .attr('y', 15)
            .attr('x', 0);


          d3.selectAll(".legend" + (i))
            .each(calcPosition);

          function calcPosition() {


            var BBox = this.getBBox()


            //prevY =BBox.width
            d3.select(".legend" + (i))
              .attr("y", function(d) {
                if ((prevX + BBox.width + 50) > parseInt(graphic.style("width"))) {
                  lineNoOld = lineNo;
                  lineNo = lineNo + 1;
                  prevX = 0;
                }
                return eval((lineNo * 20) + 20);
              })
              .attr("x", function(d) {
                return prevX + 25;
              })


            d3.select(".rect" + (i))
              .attr("y", function(d) {

                if ((prevX + BBox.width + 50) > parseInt(graphic.style("width"))) {
                  lineNoOld = lineNo;
                  lineNo = lineNo + 1;
                  prevX = 0;
                }

                if (dvc.essential.legendStyle == "rect") {
                  return eval((lineNo * 20) + 5);
                } else {
                  return eval((lineNo * 20) + 12);

                }
              })
              .attr("x", function(d) {
                return prevX;
              })

            prevX = prevX + BBox.width + 50



          }; // end function calcPosition()
        }); // end foreach
      } // end function createLegend()




      //use pym to calculate chart dimensions
      if (pymChild) {
        pymChild.sendHeight();
      }

    } // ends draw graphic



    //check whether browser can cope with svg
    if (Modernizr.svg) {
      //load config
      d3.json("config.json", function(error, config) {
        dvc = config

        //load chart data
        d3.csv(dvc.essential.graphic_data_url, function(error, data) {
          graphic_data = data;

          //use pym to create iframed chart dependent on specified variables
          pymChild = new pym.Child({
            renderCallback: drawGraphic
          });
        });
      })

    } else {
      //use pym to create iframe containing fallback image (which is set as default)
      pymChild = new pym.Child();
      if (pymChild) {
        pymChild.sendHeight();
      }
    }
  </script>
</body>

</html>
